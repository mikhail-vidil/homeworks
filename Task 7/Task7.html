<!DOCTYPE html>
<html>
    <head>
        <title>Task 7</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="css/styles.css">
        <link href="fonts/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css"> 
    </head>
    <body>
        <header class="background" style="background-image: url(images/background.jpg);">
          <div class="container">
              <div class="site-heading">
                  <h1>Houseplant Shop</h1>
              </div>
          </div> 
        </header>
        <div class="control-bar">
            <button class="btn btn-position">Add new plant</button>
            <select id="choice" onchange="selection();">
                <option value="$ Low to High">$ Low to High</option>
                <option value="$ High to Low">$ High to Low</option>
            </select>
            <a class="btn cart" href="pages/Cart.html"><i class="fas fa-1x fa-shopping-cart"></i> <span class="icon"></span></a>
        </div>
        <div class="add-new-product">
            <div class="content">
                <span class="close-button">&times;</span>
                <h1>Add new item on product grid</h1>
                <table>

                    <tr>
                        <td>Product image:</td>
                        <td>
                            <input type="file" id="input">
                        </td>
                    </tr>
                    <tr>
                        <td>Product name:</td>
                        <td><input type="text" id="name"></td>
                    </tr>
                    <tr>
                        <td>Product description:</td>
                        <td><input type="text" id="desc"></td>
                    </tr>
                    <tr>
                      <td>Product price:</td>
                      <td><input type="text" id="price"></td>
                    </tr>
                    <tr>
                      <td>Planter colors:</td>
                      <td><input type="file" id="color" multiple></td>
                    </tr>

                </table>
                <button class="btn btn-add">Add</button>
                <button class="btn btn-cancel">Cancel</button>
                
            </div>
        </div>
        <div id="p-flex">
            <div class="p-flex"><div class="p-flex-in">
              <img class="p-img" src="images/Aloe-Vera1_1.jpg"/>
              <div class="p-name">Aloe Vera</div>
              <div class="p-desc">In Mini Dolores Planter</div>
              <div class="p-price">$28</div>
              <div class="product-options">
                  <ul>
                      <li class="product-options-swatch-wrap">
                          <img src="images/swatch-blush.png" class="product-options-swatch">
                      </li>
                      <li class="product-options-swatch-wrap">
                        <img src="images/swatch-black.png" class="product-options-swatch">
                      </li>
                      <li class="product-options-swatch-wrap">
                        <img src="images/swatch-pale-grey.png" class="product-options-swatch">
                      </li>
                  </ul>
              </div>
              <button class="p-add">Add to Cart</button>
            </div></div>
            <div class="p-flex"><div class="p-flex-in">
              <img class="p-img" src="images/Pilea Peperomioides1_1.jpg"/>
              <div class="p-name">Pilea Peperomioides</div>
              <div class="p-desc">In Mini Hyde Planter</div>
              <div class="p-price">$29</div>
              <div class="product-options">
                  <ul>
                      <li class="product-options-swatch-wrap">
                          <img src="images/swatch-black.png" class="product-options-swatch">
                      </li>
                      <li class="product-options-swatch-wrap">
                        <img src="images/swatch-blush.png" class="product-options-swatch">
                      </li>
                      <li class="product-options-swatch-wrap">
                        <img src="images/swatch-pale-grey.png" class="product-options-swatch">
                      </li>
                  </ul>
              </div>
              <button class="p-add">Add to Cart</button>
            </div></div>
            <div class="p-flex"><div class="p-flex-in">
              <img class="p-img" src="images/Snake Plant Laurentii1_1.jpg"/>
              <div class="p-name">Snake Plant Laurentii</div>
              <div class="p-desc">In August Planter</div>
              <div class="p-price">$37</div>
              <div class="product-options">
                  <ul>
                      <li class="product-options-swatch-wrap">
                          <img src="images/swatch-cream.png" class="product-options-swatch">
                      </li>
                      <li class="product-options-swatch-wrap">
                        <img src="images/swatch-blush.png" class="product-options-swatch">
                      </li>
                      <li class="product-options-swatch-wrap">
                        <img src="images/swatch-black.png" class="product-options-swatch">
                      </li>
                  </ul>
              </div>
              <button class="p-add">Add to Cart</button>
            </div></div>
            <div class="p-flex"><div class="p-flex-in">
              <img class="p-img" src="images/Philodendron Green1_1.jpg"/>
              <div class="p-name">Philodendron Green</div>
              <div class="p-desc">In Olmsted Planter</div>
              <div class="p-price">$35</div>
              <div class="product-options">
                  <ul>
                      <li class="product-options-swatch-wrap">
                          <img src="images/swatch-blush.png" class="product-options-swatch">
                      </li>
                      <li class="product-options-swatch-wrap">
                        <img src="images/swatch-black.png" class="product-options-swatch">
                      </li>
                      <li class="product-options-swatch-wrap">
                        <img src="images/swatch-cream.png" class="product-options-swatch">
                      </li>
                  </ul>
              </div>
              <button class="p-add">Add to Cart</button>
            </div></div>
          </div>
          <footer>
              <div class="footer-container">
                  <ul class="list-inline text-center">
                      <li class="list-inline-item">
                          <a href="#">
                              <span class="fa-stack fa-lg">
                                  <i class="fas fa-circle fa-stack-2x"></i>
                                  <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                              </span>
                          </a>
                      </li>
                      <li class="list-inline-item">
                          <a href="#">
                              <span class="fa-stack fa-lg">
                                  <i class="fas fa-circle fa-stack-2x"></i>
                                  <i class="fab fa-facebook-f fa-stack-1x fa-inverse"></i>
                              </span>
                          </a>
                      </li>
                      <li class="list-inline-item">
                          <a href="#">
                              <span class="fa-stack fa-lg">
                                  <i class="fas fa-circle fa-stack-2x"></i>
                                  <i class="fab fa-youtube fa-stack-1x fa-inverse"></i>
                              </span>
                          </a>
                      </li>
                      <li class="list-inline-item">
                        <a href="#">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-instagram fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                        </li>
                        <li class="list-inline-item">
                            <a href="#">
                                <span class="fa-stack fa-lg">
                                    <i class="fas fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-telegram fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                  </ul>
                  <p class="copyright text-muted">&copy; 2019 All rigths reserved.</p>
              </div>
          </footer>
          <script>

            let popUp = document.querySelector(".add-new-product");
            let btn = document.querySelector(".btn");
            let closeBtn = document.querySelector(".close-button");
            let cancelBtn = document.querySelector(".btn-cancel");
            let addBtn = document.querySelector(".btn-add");
            let newFlex = document.getElementById("p-flex");
            let btnCart = document.getElementsByClassName("p-add")[0];
            let goodsQuantity = 0;
            let qty = 0;
            let images = document.getElementsByTagName('img.p-img');
            let items = [];
            let src = [];

            function togglePopUp() {
                popUp.classList.toggle("show-pop-up");
            }

            function windowOnClick(e) {
                if (e.target === popUp) {
                    togglePopUp();
                }
            }
            
            isActive();

            function addNewProduct() {
                
              let pFlex = newFlex.insertAdjacentHTML('beforeend', '<div class = "p-flex"></div>');
              pFlex = newFlex.lastChild;
              let pFlexIn = pFlex.insertAdjacentHTML('beforeend', '<div class = "p-flex-in"></div>');
              pFlexIn = document.querySelectorAll('.p-flex-in');
                
              let file = document.getElementById('input').files[0];
              let src = file.name;
              let img = document.createElement('img');
              pFlexIn[pFlexIn.length - 1].appendChild(img);
              img.setAttribute('class', 'p-img');
              img.setAttribute('src', `images/${src}`);
                
              let pName = pFlexIn[pFlexIn.length - 1].insertAdjacentHTML('beforeend', '<div class = "p-name"></div>');
              pName = document.querySelectorAll('.p-name');
              let name = document.getElementById('name').value;
              pName[pName.length - 1].innerText = name;

              let pDesc = pFlexIn[pFlexIn.length - 1].insertAdjacentHTML('beforeend', '<div class = "p-desc"></div>');
              pDesc = document.querySelectorAll('.p-desc');
              let desc = document.getElementById('desc').value;
              pDesc[pDesc.length - 1].innerText = desc;

              let pPrice = pFlexIn[pFlexIn.length - 1].insertAdjacentHTML('beforeend', '<div class = "p-price"></div>');
              pPrice = document.querySelectorAll('.p-price');
              let price = document.getElementById('price').value;
              pPrice[pDesc.length - 1].innerText = price;
              
              let fileInput = document.getElementById("color");
              let files = fileInput.files;
       
              let pOpts = pFlexIn[pFlexIn.length - 1].insertAdjacentHTML('beforeend',
              `<div class="product-options">
                  <ul>
                    <li class="product-options-swatch-wrap">
                          <img src="images/${files[0].name}" class="product-options-swatch">
                    </li>
                    <li class="product-options-swatch-wrap">
                        <img src="images/${files[1].name}" class="product-options-swatch">
                    </li>
                    <li class="product-options-swatch-wrap">
                        <img src="images/${files[2].name}" class="product-options-swatch">
                    </li>
                  </ul>
              </div>
              <button class="p-add">Add to Cart</button>
              `);
              
              planterSrc(items);
              isActive();
              togglePopUp();
            }

            
            parseProductCards();
            
            planterSrc(items);
            
            function isActive() {

              let colors = document.getElementsByClassName("product-options-swatch-wrap");
                for (let i = 0; i < colors.length; i++) {
                    colors[i].addEventListener("click", function(){
                    
                        let active = document.querySelector('.product-options-swatch-wrap.active');

                        if (active) {
                            active.classList.remove('active');
                        }
                        
                        let p = event.target.closest(".p-flex-in");
                        colors[i].classList.add('active');
                        let img = p.getElementsByTagName('img')[0];
                        
                        console.log(p);
                        img.setAttribute('src', src[i]);
                    });
                }

            }
            
            function parseProductCards() {
                let productCard = document.querySelectorAll('.p-flex');
                productCard.forEach(function(item, index){
                    let obj = {};
                    let node = item.firstElementChild;
                    let _name = node.getElementsByClassName("p-name")[0];
                    let _desc = node.getElementsByClassName("p-desc")[0];
                    let _price = node.getElementsByClassName("p-price")[0];
                    let picPath = node.getElementsByTagName('img')[0];
                    let picColor1 = node.getElementsByTagName('img')[1];
                    let picColor2 = node.getElementsByTagName('img')[2];
                    let picColor3 = node.getElementsByTagName('img')[3];
                    let colorPath1 = picColor1.getAttribute('src');
                    let colorPath2 = picColor2.getAttribute('src');
                    let colorPath3 = picColor3.getAttribute('src');
                    let str = item.innerText; 
                    obj.name = _name.innerText;
                    obj.desc = _desc.innerText;
                    obj.price = _price.innerText;
                    obj.productSrc = picPath.getAttribute('src');
                    obj.colorSrc = (colorPath1 + ' ' + colorPath2 + ' ' + colorPath3).split(' ');
                    items.push(obj);
                    console.log(_price.innerText);
                    return items;
                });
            }
                
            function sortByPriceAsc(items) {
                items.sort(function(el1, el2){
                    return parseInt(el1.price.slice(1)) > parseInt(el2.price.slice(1)) ? 1 : -1;
                });
            }

            function sortByPriceDesc(items) {
                items.sort(function(el1, el2){
                    return parseInt(el1.price.slice(1)) < parseInt(el2.price.slice(1)) ? 1 : -1;
                });
            }
            
            function planterSrc(items) {
               
                items.forEach(function(element, index){
                
                let str1 = element.productSrc;
                let str2 = str1.replace("1_1", "1_2");
                let str3 = str1.replace("1_1", "1_3");
                src.push(str1, str2, str3);
                
                if (src.length == 24) {
                    src.splice(0, 12)
                } else {
                   return src;
                }
                
                });
            }

            function writeProductCards(items) {
                items.forEach(function(element, index){
                    let flex = document.querySelectorAll(".p-flex")[index];
                    let goodName = document.getElementsByClassName("p-name")[index];
                    let goodDesc = document.getElementsByClassName("p-desc")[index];
                    let goodPrice = document.getElementsByClassName("p-price")[index];
                    let goodImg = document.getElementsByClassName("p-img")[index];
                    let color1 = flex.getElementsByTagName('img')[1];
                    let color2 = flex.getElementsByTagName('img')[2];
                    let color3 = flex.getElementsByTagName('img')[3];
                    goodName.innerHTML = element.name;
                    goodDesc.innerHTML = element.desc;
                    goodPrice.innerHTML = element.price;
                    goodImg.setAttribute('src', element.productSrc);
                    color1.setAttribute('src', element.colorSrc[0]);
                    color2.setAttribute('src', element.colorSrc[1]);
                    color3.setAttribute('src', element.colorSrc[2]);  
                });
            }

            function selection() {
        
                let sel = document.getElementById('choice').selectedIndex;
                switch(sel) {
                    case 0:
                        sortByPriceAsc(items);
                        planterSrc(items);
                        writeProductCards(items);
                    break;

                    case 1:
                        sortByPriceDesc(items);
                        planterSrc(items);
                        writeProductCards(items);
                    break;
                }
            }

            addToCart();
            let goods = [];
            function addToCart() {
                let cartBtn = document.querySelectorAll('.p-add');
                let cartInfo = document.getElementsByClassName('icon')[0];
                
                cartBtn.forEach(function(btn){
                    btn.addEventListener("click", function(event){
                        goodsQuantity++;
                        cartInfo.innerText = goodsQuantity;
                        let imgPath = event.target.parentElement.firstElementChild.src;
                        let name = event.target.parentElement.firstElementChild.nextElementSibling.innerText;
                        let desc = event.target.parentElement.firstElementChild.nextElementSibling.nextElementSibling.innerHTML;
                        let price = event.target.parentElement.lastElementChild.previousElementSibling.previousElementSibling.innerHTML;
                        
                        let item = {};
                        
                        item.name = name;
                        item.img = imgPath;
                        item.desc = desc;
                        item.price = price;
                        
                        goods.push(item);
                        //console.log(goods);
                        
                        let unique = {};
                        
                        let goodsFrequency = goods.reduce((acc, el) => {
                            acc[el.name] = acc[el.name] + 1 || 1;
                            return acc;
                        }, {});
                        
                        let goodsFiltered = goods.filter(obj => !unique[obj.name] && (unique[obj.name] = true));
                       
                        let qty = parseInt(localStorage.getItem('goodsQuantity'));
                        let data = qty ? qty + 1 : goodsQuantity;                 
                        localStorage.setItem('goodsQuantity', data);
                         
                        localStorage.setItem('goods', JSON.stringify(goodsFiltered));
                        localStorage.setItem('goodsFrequency', JSON.stringify(goodsFrequency));
                        
                    })
                })
                
            }

            function products() {
                let cartInfo = document.getElementsByClassName('icon')[0];
                let pr = localStorage.getItem('goodsQuantity');
                cartInfo.innerText = pr;
            }

            btn.addEventListener("click", togglePopUp);
            closeBtn.addEventListener("click", togglePopUp);
            cancelBtn.addEventListener("click", togglePopUp);
            addBtn.addEventListener("click", addNewProduct);
            window.addEventListener("click", windowOnClick);
            window.addEventListener('click', products);
            window.addEventListener('load', products);
          </script>
    </body>
</html>